<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <script src="https://unpkg.com/@supabase/supabase-js@latest"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حساب العمر وكتلة الجسم</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css"> <!-- ربط ملف CSS -->
</head>
<body>
    <div id="login-form">
        <h2>تسجيل الدخول</h2>
        <label for="secret-code">أدخل الكود السري:</label>
        <input type="password" id="secret-code" placeholder="الكود السري">
        <button type="button" onclick="togglePassword()">إظهار/إخفاء</button>
        <button type="button" onclick="login()">تسجيل الدخول</button>
        <p id="login-error" style="color:red;"></p> <!-- لعرض أخطاء تسجيل الدخول -->
    </div>

    <div class="calculator" style="display: none;">
        <h2>حساب العمر وكتلة الجسم (BMI)</h2>

        <label for="input">أدخل تاريخ الميلاد بصيغة B3:</label>
        <input type="text" id="input" placeholder="مثال: 320101">
        <button onclick="calculateAge()">احسب العمر</button>

        <label for="weight">أدخل الوزن (كجم):</label>
        <input type="number" id="weight" placeholder="الوزن بالكيلوغرام">
        
        <label for="height">أدخل الطول (سم):</label>
        <input type="number" id="height" placeholder="الطول بالسنتيمتر">

        <div class="gender-selection">
            <label>
                <input type="radio" id="male" name="gender" value="male" checked>
                ولد
            </label>
            <label>
                <input type="radio" id="female" name="gender" value="female">
                بنت
            </label>
        </div>

        <div class="age-options">
            <label>
                <input type="radio" name="age-option" value="age" checked>
                حساب BMI حسب العمر (5-19 سنة)
            </label>
            <label>
                <input type="radio" name="age-option" value="no-age">
                حساب BMI بدون الاعتماد على العمر
            </label>
        </div>
        
        <button onclick="calculateBMI()">احسب كتلة الجسم (BMI)</button>
        
        <p id="result"></p>
    </div>

    <script src="script.js" defer></script> <!-- ربط ملف JavaScript -->
    <script>
        // إعداد Supabase
        const supabaseUrl = 'https://rdbruokyngxxrcgewdtm.supabase.co'; // استبدل بعنوان مشروعك
        const supabaseKey = 'your_supabase_key'; // استبدل بمفتاح API الخاص بك
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let isLoggedIn = false; // حالة تسجيل الدخول

        function getDeviceId() {
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = 'device-' + Math.random().toString(36).substr(2, 9); // توليد معرف فريد
                localStorage.setItem('deviceId', deviceId); // تخزين المعرف في localStorage
            }
            return deviceId;
        }

        async function login() {
            const inputCode = document.getElementById("secret-code").value; // استخدم حقل الإدخال الصحيح
            const deviceId = getDeviceId(); // الحصول على معرف الجهاز

            // استعلام عن الأكواد السريّة في Supabase
            const { data, error } = await supabase
                .from('access_codes')
                .select('*')
                .eq('code', inputCode)
                .eq('device_id', deviceId)
                .eq('is_active', true)
                .single();

            if (error || !data) {
                document.getElementById("login-error").innerText = "الكود غير صحيح أو الجهاز غير مسموح له.";
            } else {
                isLoggedIn = true; // تسجيل الدخول بنجاح
                document.getElementById("login-form").style.display = "none"; // إخفاء نموذج تسجيل الدخول
                document.querySelector(".calculator").style.display = "block"; // عرض آلة الحاسبة
                console.log("تسجيل الدخول ناجح!");
            }
        }

        function togglePassword() {
            const passwordField = document.getElementById("secret-code");
            const type = passwordField.type === "password" ? "text" : "password";
            passwordField.type = type;
        }
    </script>
</body>
</html>
